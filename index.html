<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Subasta</title>
<style>
  :root{
    --bg:#f2f4f7;
    --card:#ffffff;
    --text:#2c3e50;
    --label:#34495e;
    --input-border:#d1d1d1;
    --result-bg:#f8fafc;
    --success:#2ecc71;
    --error:#e74c3c;
    --info:#3498db;
  }
  body.dark{
    --bg:#1e1e1e;
    --card:#2a2a2a;
    --text:#f1f1f1;
    --label:#d0d0d0;
    --input-border:#555;
    --result-bg:#333;
  }
  *{transition: all .25s ease;}
  body{
    font-family:Segoe UI,Arial,sans-serif;
    margin:0;
    background:var(--bg);
    display:flex;
    justify-content:center;
    padding:18px;
  }
  .app{width:100%;max-width:600px}
  .card{
    background:var(--card);
    padding:18px;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    margin-bottom:14px;
  }
  label{display:block;font-weight:600;color:var(--label);margin-bottom:6px}
  input, select{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1.5px solid var(--input-border);
    font-size:16px;
    margin-bottom:12px;
    background:var(--bg);
    color:var(--text);
  }
  .price-controls{display:flex;gap:8px;margin-bottom:10px}
  .small-btn{
    padding:8px 12px;
    border-radius:10px;
    border:none;
    font-weight:700;
    cursor:pointer;
    background:#3b82f6;
    color:white;
    transition:transform .15s ease;
  }
  .small-btn:active{transform:scale(0.92)}
  .btn-main{
    flex:1;
    min-width:120px;
    padding:10px;
    border-radius:10px;
    border:none;
    font-weight:700;
    cursor:pointer;
    background:#3b82f6;
    color:white;
  }
  .btn-main:active{transform:scale(0.95);}
  .header{
    background:#2c3e50;
    color:#fff;
    padding:14px;
    border-radius:14px;
    text-align:center;
    font-weight:700;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    margin-bottom:16px;
    position:relative;
  }
  .toggle-dark{
    position:absolute;
    right:12px;
    top:12px;
    cursor:pointer;
    font-size:14px;
    background:#0004;
    padding:6px 10px;
    border-radius:8px;
    color:white;
    user-select:none;
  }
  .result-box{
    background:var(--result-bg);
    padding:14px;
    border-radius:12px;
    margin-top:8px;
  }
  .res{margin:8px 0;font-size:16px}
  .ganancia{font-size:20px;font-weight:800}
  .g-pos{color:var(--success)}
  .g-neg{color:var(--error)}
  .label-inline{font-size:13px;color:#7f8c8d;margin-bottom:6px}
  .lista-compras{margin-top:16px;}
  .lista-item{
    background:var(--card);
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 3px 12px rgba(0,0,0,0.06);
  }
  .item-info{flex:1; font-size:14px;}
  .delete-btn{
    padding:4px 8px;
    background:var(--error);
    border:none;
    color:white;
    font-weight:700;
    border-radius:8px;
    cursor:pointer;
  }
  .fecha{margin-bottom:12px;text-align:center;font-weight:600;color:var(--label);}
  .notification{
    position:fixed;
    top:20px;
    right:20px;
    background:var(--info);
    color:white;
    padding:12px 18px;
    border-radius:10px;
    font-weight:600;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
    opacity:0;
    pointer-events:none;
    transition:opacity .4s ease;
    z-index:9999;
  }
  .notification.show{opacity:1; pointer-events:auto;}
  .filtros{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
  .filtros select{flex:1; min-width:120px;}
  .totales{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
  .total-box{flex:1; min-width:120px; background:var(--result-bg); padding:12px; border-radius:10px; font-weight:600; text-align:center;}
  /* Pantalla de inicio */
  #inicio{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:12px;}
  #inicio h2{margin-bottom:12px;}
  #inicio button{padding:10px 20px;font-size:16px;border-radius:10px;border:none;background:#3b82f6;color:white;cursor:pointer;}
  #inicio button:active{transform:scale(0.95);}
</style>
</head>
<body>

<div id="inicio">
  <h2>Seleccione la subasta y usuario</h2>
  <select id="subastaSelect">
    <option value="">--Seleccione Subasta--</option>
    <option value="El Progreso">El Progreso</option>
    <option value="CaÃ±as">CaÃ±as</option>
    <option value="Upala">Upala</option>
  </select>
  <select id="usuarioSelect">
    <option value="">--Seleccione Usuario--</option>
    <option value="Anyel">Anyel</option>
    <option value="Carlos">Carlos</option>
    <option value="Sandra">Sandra</option>
    <option value="Lourdes">Lourdes</option>
  </select>
  <button onclick="iniciarApp()">Entrar</button>
</div>

<div class="app" style="display:none;">
  <div class="fecha" id="fecha"></div>
  <div class="header">
    Calculadora
    <div class="toggle-dark" onclick="toggleDark()">ðŸŒ™</div>
  </div>

  <div class="card">
    <label>Peso del animal (kg)</label>
    <input id="peso" type="number" placeholder="Ej: 700" oninput="calcular()" />

    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:170px">
        <label>Precio de compra (â‚¡/kg)</label>
        <input id="precioCompra" type="number" value="0" oninput="calcular()" />
        <div class="price-controls">
          <button class="small-btn" onclick="ajustar('compra', 10)">+10</button>
          <button class="small-btn" onclick="ajustar('compra', -10)">-10</button>
        </div>
        <div class="label-inline">Se usa para calcular cuÃ¡nto pagaste</div>
      </div>

      <div style="flex:1;min-width:170px">
        <label>Precio canal / venta (â‚¡/kg)</label>
        <input id="precioCanal" type="number" value="0" oninput="calcular()" />
        <div class="price-controls">
          <button class="small-btn" onclick="ajustar('canal', 10)">+10</button>
          <button class="small-btn" onclick="ajustar('canal', -10)">-10</button>
        </div>
        <div class="label-inline">Se usa para calcular el valor del canal</div>
      </div>
    </div>

    <div class="totales">
      <div class="total-box">Total Pagado: â‚¡<span id="totalPagado">0</span></div>
      <div class="total-box">Total Ganancia: â‚¡<span id="totalGanancia">0</span></div>
    </div>

    <div class="btns-main">
      <button class="btn-main" onclick="agregarCompra()">Compra</button>
      <button class="btn-main" onclick="limpiar()">Limpiar</button>
      <button class="btn-main" onclick="exportarExcel()">Exportar a Excel</button>
      <button class="btn-main" onclick="regresarInicio()">Regresar</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;text-align:center">Resultados</h3>
    <div class="result-box">
      <div class="res"><strong>Total pagado:</strong> â‚¡<span id="pagado">0</span></div>
      <div class="res"><strong>Peso canal (peso âˆ’ 250):</strong> <span id="pesoCanal">0</span> kg</div>
      <div class="res"><strong>Valor canal:</strong> â‚¡<span id="valorCanal">0</span></div>
      <div class="res ganancia" id="gananciaText"><strong>Ganancia:</strong> â‚¡<span id="ganancia">0</span></div>
    </div>
  </div>

  <div class="card">
    <div class="filtros">
      <select id="filtroSubasta" onchange="renderLista()">  
        <option value="all">Todas las subastas</option>
        <option value="El Progreso">El Progreso</option>
        <option value="CaÃ±as">CaÃ±as</option>
        <option value="Upala">Upala</option>
      </select>
      <select id="filtroUsuario" onchange="renderLista()">  
        <option value="all">Todos los usuarios</option>
        <option value="Anyel">Anyel</option>
        <option value="Carlos">Carlos</option>
        <option value="Sandra">Sandra</option>
        <option value="Lourdes">Lourdes</option>
      </select>
    </div>
    <div class="lista-compras" id="listaCompras"></div>
  </div>
</div>

<div id="notificacion" class="notification"></div>

<script>
let compras = [];
let usuarioActual = '';
let subastaActual = '';

// --- INICIO ---
function iniciarApp(){
  const subasta = document.getElementById('subastaSelect').value;
  const usuario = document.getElementById('usuarioSelect').value;
  if(!subasta || !usuario) return alert("Seleccione subasta y usuario");
  subastaActual = subasta;
  usuarioActual = usuario;
  document.getElementById('inicio').style.display='none';
  document.querySelector('.app').style.display='block';
  mostrarFecha();
  cargarLocalStorage();
}

// --- CALCULOS ---
function calcular(){
  const peso = Number(document.getElementById('peso').value) || 0;
  const precioCompra = Number(document.getElementById('precioCompra').value) || 0;
  const precioCanal  = Number(document.getElementById('precioCanal').value) || 0;

  const pagado = peso * precioCompra;
  let pesoCanal = peso - 250;
  if (pesoCanal < 0) pesoCanal = 0;
  const valorCanal = pesoCanal * precioCanal;
  const ganancia = valorCanal - pagado;

  document.getElementById('pagado').textContent = pagado.toLocaleString('es-CR');
  document.getElementById('pesoCanal').textContent = pesoCanal;
  document.getElementById('valorCanal').textContent = valorCanal.toLocaleString('es-CR');

  const gananciaText = document.getElementById('gananciaText');
  if (ganancia < 0) {
    gananciaText.classList.add('g-neg');
    gananciaText.classList.remove('g-pos');
    gananciaText.querySelector('strong').textContent = 'PÃ©rdida:';
    document.getElementById('ganancia').textContent = (-ganancia).toLocaleString('es-CR');
  } else {
    gananciaText.querySelector('strong').textContent = 'Ganancia:';
    document.getElementById('ganancia').textContent = ganancia.toLocaleString('es-CR');
    if (ganancia < 90000) {
      gananciaText.classList.add('g-neg');
      gananciaText.classList.remove('g-pos');
    } else {
      gananciaText.classList.add('g-pos');
      gananciaText.classList.remove('g-neg');
    }
  }
}

function ajustar(tipo, delta){
  if (tipo === 'compra'){
    let el = document.getElementById('precioCompra');
    let v = Number(el.value) || 0; v += delta; if (v<0) v=0; el.value = v;
  } else {
    let el = document.getElementById('precioCanal');
    let v = Number(document.getElementById('precioCanal').value) || 0; v += delta; if (v<0) v=0; document.getElementById('precioCanal').value = v;
  }
  calcular();
}

function toggleDark(){document.body.classList.toggle("dark");}
function limpiar(){
  document.getElementById('peso').value = '';
  document.getElementById('precioCompra').value = 0;
  document.getElementById('precioCanal').value = 0;
  calcular();
}

function regresarInicio(){
  document.querySelector('.app').style.display='none';
  document.getElementById('inicio').style.display='flex';
}

// --- FECHA ---
function mostrarFecha(){
  const f = new Date();
  const fechaStr = f.toLocaleDateString('es-CR') + ' ' + f.toLocaleTimeString('es-CR');
  document.getElementById('fecha').textContent = fechaStr;
}
setInterval(mostrarFecha, 1000);

// --- LISTA ---
function renderLista(){
  const lista = document.getElementById('listaCompras');
  lista.innerHTML = '';
  const filtroSubasta = document.getElementById('filtroSubasta').value;
  const filtroUsuario = document.getElementById('filtroUsuario').value;
  let totalPagado = 0, totalGanancia = 0;
  compras.forEach((c,index)=>{
    if((filtroSubasta==='all' || c.subasta===filtroSubasta) &&
       (filtroUsuario==='all' || c.usuario===filtroUsuario)){
      totalPagado += c.pagado;
      totalGanancia += c.ganancia;
      const item = document.createElement('div');
      item.className='lista-item';
      item.innerHTML=`
        <div class="item-info">
          <strong>${c.fecha}</strong> | <em>${c.usuario}</em> | <strong>${c.subasta}</strong><br>
          Peso: ${c.peso} kg, Peso canal: ${c.pesoCanal} kg<br>
          Pagado: â‚¡${c.pagado.toLocaleString('es-CR')}, Valor venta: â‚¡${c.valorCanal.toLocaleString('es-CR')}, Ganancia: â‚¡${c.ganancia.toLocaleString('es-CR')}
        </div>
        <button class="delete-btn" onclick="eliminarCompra(${index})">X</button>
      `;
      lista.prepend(item);
    }
  });
  document.getElementById('totalPagado').textContent = totalPagado.toLocaleString('es-CR');
  document.getElementById('totalGanancia').textContent = totalGanancia.toLocaleString('es-CR');
  localStorage.setItem('compras', JSON.stringify(compras));
}

// --- COMPRA ---
function agregarCompra(){
  const peso = Number(document.getElementById('peso').value) || 0;
  if(peso<=0) return alert("Ingrese un peso vÃ¡lido");
  const precioCompra = Number(document.getElementById('precioCompra').value) || 0;
  const precioCanal = Number(document.getElementById('precioCanal').value) || 0;
  let pesoCanal = peso - 250; if (pesoCanal < 0) pesoCanal=0;
  const pagado = peso*precioCompra;
  const valorCanal = pesoCanal*precioCanal;
  const ganancia = valorCanal - pagado;
  const fecha = new Date().toLocaleString('es-CR');

  compras.push({fecha,peso,pesoCanal,pagado,valorCanal,ganancia,usuario:usuarioActual,subasta:subastaActual});
  renderLista();
  mostrarNotificacion("Compra agregada");
}

// --- ELIMINAR ---
function eliminarCompra(index){
  compras.splice(index,1);
  renderLista();
}

// --- LOCAL STORAGE ---
function cargarLocalStorage(){
  const data = localStorage.getItem('compras');
  if(data){
    compras = JSON.parse(data);
    renderLista();
  }
}

// --- EXPORTAR ---
function exportarExcel(){
  if(compras.length===0) return alert("No hay datos para exportar");
  function formatCR(num){return 'â‚¡'+num.toLocaleString('es-CR');}
  let csv = 'Fecha,Usuario,Subasta,Peso,Peso Canal,Pagado,Valor Venta,Ganancia\n';
  compras.forEach(c=>{
    csv += `"${c.fecha}","${c.usuario}","${c.subasta}",${c.peso},${c.pesoCanal},${formatCR(c.pagado)},${formatCR(c.valorCanal)},${formatCR(c.ganancia)}\n`;
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download=`compras_${subastaActual}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  mostrarNotificacion("Datos exportados");
}

// --- NOTIFICACIONES ---
function mostrarNotificacion(msg){
  const n = document.getElementById('notificacion');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(()=>n.classList.remove('show'),2500);
}

// --- Inicial ---
calcular();
</script>
</body>
</html>
