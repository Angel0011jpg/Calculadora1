<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Subastas</title>
<style>
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#f2f4f7;display:flex;justify-content:center;padding:18px;}
.card{background:#fff;padding:18px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px;}
.btn-main{padding:10px 14px;border:none;border-radius:10px;background:#3b82f6;color:white;font-weight:700;cursor:pointer;margin:4px;}
.btn-main:active{transform:scale(0.95);}
#appPrincipal{display:none;}
.lista-item{background:#eee;padding:12px;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.totales{display:flex;gap:12px;margin-bottom:12px;}
.total-box{flex:1;background:#f8fafc;padding:12px;border-radius:10px;text-align:center;font-weight:700;font-size:16px;}
.notificacion{position:fixed;top:10px;right:10px;background:#2ecc71;color:white;padding:10px 14px;border-radius:10px;display:none;z-index:1000;}
.input-card input{width:100%;padding:12px;border-radius:10px;border:1.5px solid #d1d1d1;margin-bottom:12px;font-size:16px;}
</style>
</head>
<body>

<div class="notificacion" id="notificacion"></div>

<!-- INICIO -->
<div id="inicio" class="card">
  <h2>Seleccione la subasta</h2>
  <button class="btn-main" onclick="seleccionarSubasta('El progreso')">El progreso</button>
  <button class="btn-main" onclick="seleccionarSubasta('Cañas')">Cañas</button>
  <button class="btn-main" onclick="seleccionarSubasta('Upala')">Upala</button>
  <h3>Seleccione usuario</h3>
  <select id="usuarioSelect">
    <option value="Anyel">Anyel</option>
    <option value="Carlos">Carlos</option>
    <option value="Sandra">Sandra</option>
    <option value="Lourdes">Lourdes</option>
  </select>
</div>

<!-- APP PRINCIPAL -->
<div id="appPrincipal">
  <div class="card input-card">
    <h2 id="tituloSubasta"></h2>
    <label>Peso del animal (kg)</label>
    <input type="number" id="peso">
    <label>Precio compra (₡/kg)</label>
    <input type="number" id="precioCompra">
    <label>Precio venta (₡/kg)</label>
    <input type="number" id="precioCanal">
    <div>
      <button class="btn-main" onclick="agregarCompra()">Agregar Compra</button>
      <button class="btn-main" onclick="regresarInicio()">Regresar al inicio</button>
      <button class="btn-main" onclick="exportarExcel()">Exportar a Excel</button>
      <button class="btn-main" onclick="limpiarInputs()">Limpiar</button>
    </div>
  </div>

  <div class="totales">
    <div class="total-box">Total Pagado: ₡<span id="totalPagado">0</span></div>
    <div class="total-box">Ganancia Total: ₡<span id="totalGanancia">0</span></div>
  </div>

  <div class="card">
    <h3>Lista de compras</h3>
    <div id="listaCompras"></div>
  </div>
</div>

<script>
let subastaSeleccionada = '';
let usuarioSeleccionado = '';
let compras = [];

// --- NOTIFICACIÓN ---
function notificar(msg){
  const n = document.getElementById('notificacion');
  n.textContent = msg;
  n.style.display='block';
  setTimeout(()=>{n.style.display='none';},2000);
}

// --- SELECCIÓN SUBASTA ---
function seleccionarSubasta(subasta){
  subastaSeleccionada = subasta;
  usuarioSeleccionado = document.getElementById('usuarioSelect').value || 'Anyel';
  document.getElementById('inicio').style.display='none';
  document.getElementById('appPrincipal').style.display='block';
  document.getElementById('tituloSubasta').textContent = `Subasta: ${subasta} | Usuario: ${usuarioSeleccionado}`;
  cargarCompras();
}

// --- REGRESAR ---
function regresarInicio(){
  document.getElementById('inicio').style.display='block';
  document.getElementById('appPrincipal').style.display='none';
}

// --- LIMPIAR INPUTS ---
function limpiarInputs(){
  document.getElementById('peso').value='';
  document.getElementById('precioCompra').value='';
  document.getElementById('precioCanal').value='';
}

// --- AGREGAR COMPRA ---
function agregarCompra(){
  const peso = Number(document.getElementById('peso').value) || 0;
  const precioCompra = Number(document.getElementById('precioCompra').value) || 0;
  const precioCanal = Number(document.getElementById('precioCanal').value) || 0;
  if(peso <= 0) return alert('Ingrese un peso válido');

  const pesoCanal = Math.max(0, peso - 250);
  const pagado = peso * precioCompra;
  const valorCanal = pesoCanal * precioCanal;
  const ganancia = valorCanal - pagado;
  const fecha = new Date().toLocaleString('es-CR');

  const nuevaCompra = {fecha, peso, pesoCanal, pagado, valorCanal, ganancia, usuario: usuarioSeleccionado};
  compras.push(nuevaCompra);
  localStorage.setItem('compras', JSON.stringify(compras));
  renderLista();
  limpiarInputs();
  notificar('Compra agregada');
}

// --- CARGAR COMPRAS ---
function cargarCompras(){
  const data = localStorage.getItem('compras');
  compras = data ? JSON.parse(data) : [];
  renderLista();
}

// --- RENDER LISTA Y TOTALES ---
function renderLista(){
  const lista = document.getElementById('listaCompras');
  lista.innerHTML='';
  let totalPagado = 0;
  let totalGanancia = 0;

  compras.forEach((c,index)=>{
    totalPagado += c.pagado;
    totalGanancia += c.ganancia;

    const div = document.createElement('div');
    div.className='lista-item';
    div.innerHTML = `
      <div>${c.fecha} - ${c.usuario} | Peso: ${c.peso}kg, Canal: ${c.pesoCanal}kg, Pagado: ₡${c.pagado.toLocaleString('es-CR')}, Venta: ₡${c.valorCanal.toLocaleString('es-CR')}, Ganancia: ₡${c.ganancia.toLocaleString('es-CR')}</div>
      <button onclick="eliminarCompra(${index})" class="btn-main" style="background:#e74c3c">Eliminar</button>
    `;
    lista.appendChild(div);
  });

  document.getElementById('totalPagado').textContent = totalPagado.toLocaleString('es-CR');
  document.getElementById('totalGanancia').textContent = totalGanancia.toLocaleString('es-CR');
}

// --- ELIMINAR COMPRA ---
function eliminarCompra(index){
  compras.splice(index,1);
  localStorage.setItem('compras', JSON.stringify(compras));
  renderLista();
  notificar('Compra eliminada');
}

// --- EXPORTAR A EXCEL ---
function exportarExcel(){
  if(compras.length === 0) return alert('No hay datos para exportar');
  let csv = 'Fecha,Usuario,Peso,Peso Canal,Pagado,Valor Venta,Ganancia,Subasta\n';
  compras.forEach(c=>{
    csv += `"${c.fecha}","${c.usuario}",${c.peso},${c.pesoCanal},${c.pagado},${c.valorCanal},${c.ganancia},"${subastaSeleccionada}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `compras_${subastaSeleccionada}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  notificar('Datos exportados');
}

// --- CARGAR DATOS AL INICIO ---
cargarCompras();
</script>
</body>
</html>
