<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<!-- ANTI-ZOOM: bloquea pinch + doble-tap accidental en mÃ³viles -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Calculadora Subasta</title>
<style>
/* ---------- ANTI-ZOOM / TOUCH UX ---------- */
/* Evita que el navegador haga zoom al tocar rÃ¡pido/doble-tap en elementos interactivos */
button, .small-btn, .btn-main, .delete-btn, input, select {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
}

/* Evita selecciÃ³n y popups en iOS */
* {
  -webkit-touch-callout: none;
}

/* ---------- RESTO DE ESTILOS (ORIGINAL) ---------- */
:root{
  --bg:#f2f4f7;
  --card:#ffffff;
  --text:#2c3e50;
  --label:#34495e;
  --input-border:#d1d1d1;
  --result-bg:#f8fafc;
  --success:#2ecc71;
  --error:#e74c3c;
  --info:#3498db;
}
body.dark{
  --bg:#1e1e1e;
  --card:#2a2a2a;
  --text:#f1f1f1;
  --label:#d0d0d0;
  --input-border:#555;
  --result-bg:#333;
}
*{transition: all .25s ease;}
body{
  font-family:Segoe UI,Arial,sans-serif;
  margin:0;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:12px;
}
.app{
  width:100%;
  max-width:600px;
  display:flex;
  flex-direction:column;
}

/* --- CARDS --- */
.card{
  background:var(--card);
  padding:18px;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  margin-bottom:16px;
}
label{
  display:block;
  font-weight:600;
  color:var(--label);
  margin-bottom:6px;
  font-size:15px;
}
input, select{
  width:100%;
  padding:16px;
  border-radius:12px;
  border:1.5px solid var(--input-border);
  font-size:16px;
  margin-bottom:12px;
  background:var(--bg);
  color:var(--text);
  box-sizing:border-box;
}
.price-controls{
  display:flex;
  gap:8px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.small-btn{
  padding:10px 16px;
  border-radius:12px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:#3b82f6;
  color:white;
  transition:transform .15s ease;
}
.small-btn:active{transform:scale(0.92)}
.btn-main{
  flex:1;
  min-width:120px;
  padding:14px;
  border-radius:14px;
  border:none;
  font-weight:700;
  cursor:pointer;
  background:#3b82f6;
  color:white;
  font-size:16px;
}
.btn-main:active{transform:scale(0.95);}

/* --- HEADER --- */
.header{
  margin-bottom:0;
  padding:16px;
  border-radius:16px 16px 0 0;
  text-align:center;
  font-weight:700;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  font-size:18px;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}

/* --- TOGGLE DARK --- */
.toggle-dark{
  position:absolute;
  right:12px;
  top:12px;
  cursor:pointer;
  font-size:22px;
  background:#0004;
  padding:8px 14px;
  border-radius:10px;
  color:white;
  user-select:none;
}

/* --- RESULTADOS --- */
.result-box{
  background:var(--result-bg);
  padding:16px;
  border-radius:14px;
  margin-top:8px;
}
.res{margin:8px 0;font-size:16px; line-height:1.4;}
.ganancia{font-size:20px;font-weight:800}
.g-pos{color:var(--success)}
.g-neg{color:var(--error)}
.label-inline{font-size:13px;color:#7f8c8d;margin-bottom:6px}

/* --- LISTA DE COMPRAS --- */
.lista-compras{
  margin-top:16px;
  max-height:400px;
  overflow-y:auto;
  padding-right:4px;
}
.lista-item{
  background:var(--card);
  padding:14px;
  border-radius:14px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  box-shadow:0 4px 14px rgba(0,0,0,0.07);
  flex-wrap:wrap;
}
.item-info{
  flex:1;
  font-size:14px;
  line-height:1.4;
}
.delete-btn{
  padding:6px 12px;
  background:var(--error);
  border:none;
  color:white;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  margin-top:6px;
}

/* --- FILTROS ABAJO --- */
.filtros{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.filtros select{
  flex:1;
  min-width:120px;
}

/* --- FECHA --- */
.fecha{
  margin-bottom:12px;
  text-align:center;
  font-weight:600;
  color:var(--label);
  font-size:14px;
}

/* --- NOTIFICACION --- */
.notification{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--info);
  color:white;
  padding:14px 20px;
  border-radius:12px;
  font-weight:600;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  opacity:0;
  pointer-events:none;
  transition:opacity .4s ease;
  z-index:9999;
}
.notification.show{opacity:1; pointer-events:auto;}

/* --- TOTALES --- */
.totales{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.total-box{
  flex:1; 
  min-width:120px; 
  background:var(--result-bg); 
  padding:14px; 
  border-radius:12px; 
  font-weight:600; 
  text-align:center;
  font-size:15px;
}

/* --- PANTALLA DE INICIO --- */
#inicio{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
  gap:16px;
  padding:0 16px;
  box-sizing:border-box;
}
#inicio h2{
  margin-bottom:12px;
  text-align:center;
  font-size:18px;
}
#inicio button{
  padding:14px 22px;
  font-size:16px;
  border-radius:14px;
  border:none;
  background:#3b82f6;
  color:white;
  cursor:pointer;
}
#inicio button:active{transform:scale(0.95);}

/* --- RESPONSIVE --- */
@media (max-width: 600px){
  .totales{
    flex-direction:column;
  }
  .total-box{
    flex:1 1 100%;
    margin-bottom:8px;
  }
  .btns-main{
    flex-direction:column;
  }
  .btn-main{
    width:100%;
    margin-bottom:10px;
  }
  .lista-item{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .delete-btn{
    align-self:flex-end;
  }
  .price-controls{
    gap:6px;
  }
  input, select{
    font-size:16px;
    padding:14px;
  }
  .toggle-dark{
    font-size:24px;
    padding:8px 16px;
  }
  #inicio{
    padding:12px;
  }
}
</style>
</head>
<body>

<div id="inicio">
  <h2>Seleccione la subasta y usuario</h2>
  <select id="subastaSelect">
    <option value="">--Seleccione Subasta--</option>
    <option value="El Progreso">El Progreso</option>
    <option value="CaÃ±as">CaÃ±as</option>
    <option value="Upala">Upala</option>
  </select>
  <select id="usuarioSelect">
    <option value="">--Seleccione Usuario--</option>
    <option value="Anyel">Anyel</option>
    <option value="Carlos">Carlos</option>
    <option value="Sandra">Sandra</option>
  </select>
  <button onclick="iniciarApp()">Entrar</button>
</div>

<div class="app" style="display:none;">
  <div class="fecha" id="fecha"></div>
  <div class="header">
    Calculadora
    <div class="toggle-dark" onclick="toggleDark()">ðŸŒ™</div>
  </div>

  <div class="card">
    <label>Peso del animal (kg)</label>
    <input id="peso" type="number" placeholder="Ej: 700" oninput="calcular()" />

    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:170px">
        <label>Precio de compra (â‚¡/kg)</label>
        <input id="precioCompra" type="number" value="0" oninput="calcular()" />
        <div class="price-controls">
          <button class="small-btn" onclick="ajustar('compra', 10)">+10</button>
          <button class="small-btn" onclick="ajustar('compra', -10)">-10</button>
        </div>
      </div>

      <div style="flex:1;min-width:170px">
        <label>Precio canal / venta (â‚¡/kg)</label>
        <input id="precioCanal" type="number" value="0" oninput="calcular()" />
        <div class="price-controls">
          <button class="small-btn" onclick="ajustar('canal', 5)">+5</button>
          <button class="small-btn" onclick="ajustar('canal', -5)">-5</button>
        </div>
      </div>
    </div>

    <div class="totales">
      <div class="total-box">Total Pagado: â‚¡<span id="totalPagado">0</span></div>
      <div class="total-box">Total Ganancia: â‚¡<span id="totalGanancia">0</span></div>
    </div>

    <div class="btns-main">
      <button class="btn-main" onclick="agregarCompra()">Compra</button>
      <button class="btn-main" onclick="limpiar()">Limpiar</button>
      <button class="btn-main" onclick="exportarExcel()">Exportar a Excel</button>
      <button class="btn-main" onclick="regresarInicio()">Regresar</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;text-align:center">Resultados</h3>
    <div class="result-box">
      <div class="res"><strong>Total pagado:</strong> â‚¡<span id="pagado">0</span></div>
      <div class="res"><strong>Peso canal (peso âˆ’ 250):</strong> <span id="pesoCanal">0</span> kg</div>
      <div class="res"><strong>Valor canal:</strong> â‚¡<span id="valorCanal">0</span></div>
      <div class="res ganancia" id="gananciaText"><strong>Ganancia:</strong> â‚¡<span id="ganancia">0</span></div>
    </div>
  </div>

  <div class="card">
    <div class="filtros">
      <select id="filtroSubasta" onchange="renderLista()">  
        <option value="all">Todas las subastas</option>
        <option value="El Progreso">El Progreso</option>
        <option value="CaÃ±as">CaÃ±as</option>
        <option value="Upala">Upala</option>
      </select>
      <select id="filtroUsuario" onchange="renderLista()">  
        <option value="all">Todos los usuarios</option>
        <option value="Anyel">Anyel</option>
        <option value="Carlos">Carlos</option>
        <option value="Sandra">Sandra</option>
      </select>
    </div>
    <div class="lista-compras" id="listaCompras"></div>
  </div>
</div>

<div id="notificacion" class="notification"></div>

<script>
/* ---------------------------
   ANTI-ZOOM: PINCH + DOUBLE-TAP
   - Previene pinch zoom (2 dedos)
   - Previene double-tap zoom pero mantiene el click del segundo toque
----------------------------*/
(function() {
  // Previene pinch (si hay mÃ¡s de 1 touch)
  document.addEventListener('touchmove', function(e){
    if (e.touches && e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });

  // Manejo para evitar el zoom por doble-tap:
  // Si detectamos un touchstart muy rÃ¡pido despuÃ©s del anterior, prevenimos el comportamiento
  // por defecto (zoom) y disparamos manualmente un click en el elemento tocado.
  let lastTouch = 0;
  const DELAY_MS = 300; // umbral para considerar doble-tap

  document.addEventListener('touchstart', function(e){
    const now = Date.now();
    const dt = now - lastTouch;
    if (dt > 0 && dt <= DELAY_MS) {
      // Segundo toque rÃ¡pido: prevenir zoom y forzar click
      e.preventDefault(); // evita zoom en iOS/Android
      const touch = e.changedTouches && e.changedTouches[0];
      if (touch) {
        // Obtener elemento en coordenadas del toque y disparar click
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target) {
          // dispatchEvent click de forma segura
          try {
            target.click();
          } catch(err){ /* no fatal */ }
        }
      }
    }
    lastTouch = now;
  }, { passive: false });

  // Algunos navegadores iOS antiguos disparan 'gesturestart' para pellizcos: prevenirlo si existe
  window.addEventListener('gesturestart', function(e){
    e.preventDefault();
  }, { passive: false });
})();

/* ---------- TU JS ORIGINAL (sin cambios) ---------- */

let compras = [];
let usuarioActual = '';
let subastaActual = '';

function iniciarApp(){
  const subasta = document.getElementById('subastaSelect').value;
  const usuario = document.getElementById('usuarioSelect').value;
  if(!subasta || !usuario) return alert("Seleccione subasta y usuario");
  subastaActual = subasta;
  usuarioActual = usuario;
  document.getElementById('inicio').style.display='none';
  document.querySelector('.app').style.display='flex';
  mostrarFecha();
  cargarLocalStorage();
}

function calcular(){
  const peso = Number(document.getElementById('peso').value) || 0;
  const precioCompra = Number(document.getElementById('precioCompra').value) || 0;
  const precioCanal  = Number(document.getElementById('precioCanal').value) || 0;

  const pagado = peso * precioCompra;
  let pesoCanal = peso - 250;
  if (pesoCanal < 0) pesoCanal = 0;
  const valorCanal = pesoCanal * precioCanal;
  const ganancia = valorCanal - pagado;

  document.getElementById('pagado').textContent = pagado.toLocaleString('es-CR');
  document.getElementById('pesoCanal').textContent = pesoCanal;
  document.getElementById('valorCanal').textContent = valorCanal.toLocaleString('es-CR');

  const gananciaText = document.getElementById('gananciaText');
  if (ganancia < 0) {
    gananciaText.classList.add('g-neg');
    gananciaText.classList.remove('g-pos');
    gananciaText.querySelector('strong').textContent = 'PÃ©rdida:';
    document.getElementById('ganancia').textContent = (-ganancia).toLocaleString('es-CR');
  } else {
    gananciaText.querySelector('strong').textContent = 'Ganancia:';
    document.getElementById('ganancia').textContent = ganancia.toLocaleString('es-CR');
    if (ganancia < 90000) {
      gananciaText.classList.add('g-neg');
      gananciaText.classList.remove('g-pos');
    } else {
      gananciaText.classList.add('g-pos');
      gananciaText.classList.remove('g-neg');
    }
  }
}

function ajustar(tipo, delta){
  if(tipo==='compra'){
    let el=document.getElementById('precioCompra');
    let v=Number(el.value)||0; v+=delta; if(v<0)v=0; el.value=v;
  }else{
    let el=document.getElementById('precioCanal');
    let v=Number(el.value)||0; v+=delta; if(v<0)v=0; el.value=v;
  }
  calcular();
}

function toggleDark(){document.body.classList.toggle("dark");}
function limpiar(){
  document.getElementById('peso').value='';
  document.getElementById('precioCompra').value=0;
  calcular();
}

function regresarInicio(){
  document.querySelector('.app').style.display='none';
  document.getElementById('inicio').style.display='flex';
}

function mostrarFecha(){
  const f=new Date();
  document.getElementById('fecha').textContent=f.toLocaleDateString('es-CR')+' '+f.toLocaleTimeString('es-CR');
}
setInterval(mostrarFecha,1000);

function renderLista(){
  const lista=document.getElementById('listaCompras');
  lista.innerHTML='';
  let totalPagado=0, totalGanancia=0;
  const filtroSubasta=document.getElementById('filtroSubasta').value;
  const filtroUsuario=document.getElementById('filtroUsuario').value;
  compras.forEach((c,index)=>{
    if((filtroSubasta==='all'||c.subasta===filtroSubasta) &&
       (filtroUsuario==='all'||c.usuario===filtroUsuario)){
      totalPagado+=c.pagado;
      totalGanancia+=c.ganancia;
      const item=document.createElement('div');
      item.className='lista-item';
      item.innerHTML=`
        <div class="item-info">
          <strong>${c.fecha}</strong> | <em>${c.usuario}</em> | <strong>${c.subasta}</strong><br>
          Peso: ${c.peso} kg, Precio compra: â‚¡${c.precioCompra.toLocaleString('es-CR')}<br>
          Total pagado: â‚¡${c.pagado.toLocaleString('es-CR')}, Precio canal: â‚¡${c.precioCanal.toLocaleString('es-CR')}, Ganancia: â‚¡${c.ganancia.toLocaleString('es-CR')}
        </div>
        <button class="delete-btn" onclick="eliminarCompra(${index})">Eliminar</button>
      `;
      lista.appendChild(item);
    }
  });
  document.getElementById('totalPagado').textContent=totalPagado.toLocaleString('es-CR');
  document.getElementById('totalGanancia').textContent=totalGanancia.toLocaleString('es-CR');
  guardarLocalStorage();
}

function agregarCompra(){
  const peso=Number(document.getElementById('peso').value)||0;
  if(peso<=0) return alert("Ingrese un peso vÃ¡lido");
  const precioCompra=Number(document.getElementById('precioCompra').value)||0;
  const precioCanal=Number(document.getElementById('precioCanal').value)||0;
  let pesoCanal=peso-250;if(pesoCanal<0)pesoCanal=0;
  const pagado=peso*precioCompra;
  const valorCanal=pesoCanal*precioCanal;
  const ganancia=valorCanal-pagado;
  const fecha=new Date().toLocaleString('es-CR');

  compras.push({fecha,peso,pesoCanal,pagado,valorCanal,ganancia,usuario:usuarioActual,subasta:subastaActual,precioCompra,precioCanal});
  renderLista();
  limpiar();
  mostrarNotificacion("Compra agregada");
}

function eliminarCompra(index){
  compras.splice(index,1);
  renderLista();
  mostrarNotificacion("Compra eliminada");
}

function guardarLocalStorage(){
  localStorage.setItem('compras',JSON.stringify(compras));
}
function cargarLocalStorage(){
  const data=localStorage.getItem('compras');
  if(data){compras=JSON.parse(data); renderLista();}
}

function exportarExcel(){
  if(compras.length===0) return alert("No hay datos para exportar");
  function formatCR(num){return 'â‚¡'+num.toLocaleString('es-CR');}
  let csv='Fecha,Usuario,Subasta,Peso,PrecioCompra,PrecioCanal,Total Pagado,Valor Canal,Ganancia\n';
  compras.forEach(c=>{
    csv+=`"${c.fecha}","${c.usuario}","${c.subasta}",${c.peso},${c.precioCompra},${c.precioCanal},${formatCR(c.pagado)},${formatCR(c.valorCanal)},${formatCR(c.ganancia)}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`compras_${subastaActual}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  mostrarNotificacion("Datos exportados");
}

function mostrarNotificacion(msg){
  const n=document.getElementById('notificacion');
  n.textContent=msg;
  n.classList.add('show');
  setTimeout(()=>n.classList.remove('show'),2500);
}

calcular();
</script>

</body>
</html>